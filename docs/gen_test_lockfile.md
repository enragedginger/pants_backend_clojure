# Generating Lockfiles for Integration Tests

## Overview

Integration tests that execute Clojure code require proper lockfiles containing all JVM dependencies and their transitive dependencies. Empty or placeholder lockfiles will cause runtime failures when Pants attempts to resolve dependencies.

## Why Proper Lockfiles Are Required

When integration tests actually run Clojure code (not just test dependency inference), Pants needs to:
1. Resolve all declared `jvm_artifact` dependencies
2. Download the JAR files
3. Include transitive dependencies in the classpath
4. Verify checksums and versions match the lockfile

An empty lockfile or placeholder like `"# Empty lockfile for testing\n"` will fail because Pants cannot resolve the artifacts.

## Steps to Generate a Test Lockfile

### 1. Create a Temporary Directory Structure

```bash
mkdir -p .tmp_test_lockfile/3rdparty/jvm
```

### 2. Create `pants.toml` with Required Configuration

Create `.tmp_test_lockfile/pants.toml`:

```toml
[GLOBAL]
pants_version = "2.25.0.dev3"

backend_packages = [
  "pants.backend.experimental.java",
]

# IMPORTANT: Include Clojars repository for Clojure libraries
[coursier]
repos = [
  "https://maven-central.storage-download.googleapis.com/maven2",
  "https://repo1.maven.org/maven2",
  "https://repo.clojars.org/",  # Required for most Clojure libraries
]

[jvm.resolves]
jvm-default = "3rdparty/jvm/default.lock"
```

**Critical:** The `[coursier]` section must include `https://repo.clojars.org/` because most Clojure libraries (including timbre, core.async, etc.) are published to Clojars, not Maven Central.

### 3. Create BUILD File with JVM Artifacts

Create `.tmp_test_lockfile/3rdparty/jvm/BUILD` with the artifacts you need:

```python
jvm_artifact(
    name="org.clojure_clojure",
    group="org.clojure",
    artifact="clojure",
    version="1.12.0",
)

jvm_artifact(
    name="com.taoensso_timbre",
    group="com.taoensso",
    artifact="timbre",
    version="6.3.1",
)
```

### 4. Generate the Lockfile

```bash
cd .tmp_test_lockfile
pants generate-lockfiles --resolve=jvm-default
```

This will create `3rdparty/jvm/default.lock` with:
- All direct dependencies
- All transitive dependencies
- SHA256 checksums
- File sizes
- Dependency graph metadata

### 5. Copy Lockfile Contents to Test

Read the generated lockfile:

```bash
cat 3rdparty/jvm/default.lock
```

Copy the contents into your test file using `dedent()`:

```python
"3rdparty/jvm/default.lock": dedent(
    """\
    # This lockfile was autogenerated by Pants. To regenerate, run:
    #
    #    pants generate-lockfiles
    #
    # --- BEGIN PANTS LOCKFILE METADATA: DO NOT EDIT OR REMOVE ---
    # {
    #   "version": 1,
    #   "generated_with_requirements": [
    #     "com.taoensso:timbre:6.3.1,url=not_provided,jar=not_provided",
    #     "org.clojure:clojure:1.12.0,url=not_provided,jar=not_provided"
    #   ]
    # }
    # --- END PANTS LOCKFILE METADATA ---

    [[entries]]
    file_name = "com.taoensso_timbre_6.3.1.jar"
    # ... rest of lockfile ...
    """
),
```

### 6. Clean Up

```bash
rm -rf .tmp_test_lockfile
```

## Example: Complete Test Setup

See `pants-plugins/tests/test_dependency_inference_integration.py::test_infer_transitive_clojure_dependencies` for a complete example that:

1. Declares `jvm_artifact` targets for Clojure and Timbre
2. Uses a properly generated lockfile with all transitive dependencies
3. Declares explicit dependencies on JVM artifacts in Clojure targets
4. Tests dependency inference for first-party dependencies
5. Actually runs the Clojure test to verify end-to-end functionality

## Common Issues

### Issue: "not found" errors during lockfile generation

**Symptom:**
```
Resolution error: Error downloading com.taoensso:timbre:6.3.1
  not found: https://repo1.maven.org/maven2/com/taoensso/timbre/6.3.1/timbre-6.3.1.pom
```

**Solution:** Add Clojars repository to `[coursier]` section in `pants.toml`:
```toml
[coursier]
repos = [
  "https://maven-central.storage-download.googleapis.com/maven2",
  "https://repo1.maven.org/maven2",
  "https://repo.clojars.org/",
]
```

### Issue: Test fails with "Process execution failure"

**Symptom:** Test runs but fails during dependency resolution

**Solution:** Ensure lockfile includes all transitive dependencies. Regenerate the lockfile - don't manually edit it.

### Issue: Wrong Pants version

**Symptom:** Generated lockfile format doesn't match what's expected

**Solution:** Ensure the `pants_version` in the temporary `pants.toml` matches your project's Pants version.

## Lockfile Contents Explained

A proper lockfile contains:

1. **Metadata section** - Lists all root requirements
2. **Entry per artifact** - Each JAR file gets an `[[entries]]` section containing:
   - `file_name` - The JAR filename
   - `directDependencies` - Immediate dependencies of this artifact
   - `dependencies` - All transitive dependencies (flattened)
   - `coord` - Maven coordinates (group, artifact, version)
   - `file_digest` - SHA256 fingerprint and file size

Example entry:
```toml
[[entries]]
file_name = "com.taoensso_timbre_6.3.1.jar"
[[entries.directDependencies]]
group = "com.taoensso"
artifact = "encore"
version = "3.68.0"
packaging = "jar"

[[entries.dependencies]]
group = "com.taoensso"
artifact = "encore"
version = "3.68.0"
packaging = "jar"

[[entries.dependencies]]
group = "org.clojure"
artifact = "clojure"
version = "1.12.0"
packaging = "jar"

[entries.coord]
group = "com.taoensso"
artifact = "timbre"
version = "6.3.1"
packaging = "jar"

[entries.file_digest]
fingerprint = "877d0dd59cd4512dde125caeae361253adc637f6348d731bc565a9fb8ae6d95c"
serialized_bytes_length = 50700
```

## When to Generate a New Lockfile

Generate a new lockfile when:
- Adding new JVM dependencies to tests
- Updating version numbers
- The existing lockfile is causing resolution failures
- Adding tests that actually execute Clojure code (not just inference tests)

## Tips

1. **Keep it minimal** - Only include artifacts actually needed by the test
2. **Don't hand-edit** - Always regenerate using `pants generate-lockfiles`
3. **Check transitive deps** - Verify all transitive dependencies are included (Clojure libraries often have many)
4. **Use Clojars** - Most Clojure libraries require the Clojars repository
5. **Version consistency** - Ensure artifact versions in BUILD match the lockfile metadata
